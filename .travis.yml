language: node_js

env:
  global:
    - CXX=g++-4.8
    - ARTIFACTS_BUCKET=ds-server-artifacts

node_js:
  - "stable"
  - "4.4.4"

matrix:
  include:
    - node_js: "4.4.4"
      os: osx

script:
  - npm run ci
  - chmod 555 scripts/package.sh && scripts/package.sh

after_script:
  - "cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js"

deploy:
  - provider: s3
    access_key_id: "AKIAIC5J3AF5E2HIQ3LA"
    secret_access_key:
      secure: "M7d7cMOd6h88VnYJxFh9zVtBKexqIP2vCWxydvSLUa5ctQlhYbsc7F+qBciH3uU8un+Ghn47CaWLhS7rCuQl5Y6KApbK97cA27JFTjCfCbjjZOh/pJEKuYP6FQJBUm62ARfsTZtblB+XWf7rZCzimyZNbSWZguOWeaMG2SMg1erFkSz5XXx03QXhvElK5ug96HVPkFV0v3yuAXEcE8gB/ulaDg9DD3HL1u8fjGAhMiHhCl6495biloBaKqcgFDSVUIDpkfttc8/C+m0hWD9XDoPAGa/N/4vuvAY0kRynE0quutZHhDVY9LxL1tc7CddWBNWCr+2QFHlzsDBzPjDGtNY/9KFSD+02HmCbpsUP9dRzDlp7mdItSqYcWgZRuiHt/Z66UYeAChvGbG1RYUDV9O/v1Y6s7fWGGcUzVFuMfJvq0FXmt5ZAEV+E5JB73h66BOl97Lzszt4anQfjLBLUdZlLFGYwfH/aFRIbkVHfBb2WjhNfVqLnUOJnoyaSdq3ikb1erNs1BoVP+I1xo9zJXLbU3lvVld3Ot7z4Jj1Ps/nx+LSjQsyZB1kimZG36278WvZVoVBxqtqt91jvygFyh8gYXuBCCw4ZFhmzn6z/R79rd1IHs+UY3tF7Cv7mQS4qCanhhZLWG3GANZgxfTicIh19GEpOHzFuO6vUnNYcXjs="
    bucket: ds-server-artifacts
    skip_cleanup: true
    acl: public_read
    local_dir: build
    upload-dir: $TRAVIS_REPO_SLUG
  - provider: releases
    api_key:
      secure: "Nza9Tduc8r2OUTXf/DVX78mL1OejgpBaOo/nZ1zJxco6v/fXtoHYjfplkqUW/bloZkeS2w88dG5fLreuQkwSQ/Zod6S0An7qTHaJ/sLN1ivVPzGoW+lwI/xvF+w11INpmQzkCQmGmsnnUzDCSyNYGluW+hZdCshpQ6ZWd3hbNKU="
    file: "$( ls build/*/* | grep '/deepstream.io-[^-]*-'[^-]*-[mac:linux] )"
    on:
      tags: true

plugins:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - g++-4.8